{% extends 'base_public.html' %}
{% block title %}Invoice {{ invoice.number }}{% endblock %}
{% block content %}
<div class="card max-w-2xl">
  <h1 class="text-xl font-semibold mb-4">Invoice {{ invoice.number }}</h1>
  <div class="grid grid-cols-2 gap-4 text-sm mb-6">
    <div>
      <p class="text-slate-500">Quote Ref</p>
      <p class="font-medium">{{ invoice.quote.reference }}</p>
    </div>
    <div>
      <p class="text-slate-500">Created</p>
      <p>{{ invoice.created_at|date:'Y-m-d H:i' }}</p>
    </div>
    <div>
      <p class="text-slate-500">Client</p>
      <p>{{ invoice.client_name }} ({{ invoice.client_email }})</p>
    </div>
    <div>
      <p class="text-slate-500">Status</p>
      {% if invoice.status == 'paid' %}
        <span class="inline-block px-2 py-0.5 rounded bg-green-100 text-green-700 text-xs font-semibold">Paid{% if invoice.paid_at %} at {{ invoice.paid_at|date:'Y-m-d H:i' }}{% endif %}</span>
      {% else %}
        <span class="inline-block px-2 py-0.5 rounded bg-yellow-100 text-yellow-700 text-xs font-semibold">Unpaid</span>
      {% endif %}
    </div>
  </div>
  <div class="mb-6">
    <h2 class="text-sm font-semibold text-slate-700 mb-2">Totals</h2>
    <ul class="text-sm space-y-1">
      <li><span class="text-slate-500">Subtotal:</span> £{{ invoice.subtotal }}</li>
      <li><span class="text-slate-500">Delivery:</span> £{{ invoice.delivery_price }}</li>
      <li><span class="text-slate-500">VAT:</span> £{{ invoice.vat_amount }}</li>
      <li class="font-semibold"><span class="text-slate-600">Total:</span> £{{ invoice.total }}</li>
    </ul>
  </div>
  <div class="mb-6">
    <h2 class="text-sm font-semibold text-slate-700 mb-2">Payments</h2>
    {% if payments %}
    <table class="min-w-full text-xs">
      <thead class="border-b">
        <tr class="text-slate-600">
          <th class="py-1 pr-3 text-left">Created</th>
          <th class="py-1 pr-3 text-left">Method</th>
          <th class="py-1 pr-3 text-left">Provider</th>
          <th class="py-1 pr-3 text-left">Reference</th>
          <th class="py-1 pr-3 text-left">Status</th>
          <th class="py-1 pr-3 text-right">Amount</th>
        </tr>
      </thead>
      <tbody class="divide-y">
        {% for p in payments %}
        <tr>
          <td class="py-1 pr-3">{{ p.created_at|date:'Y-m-d H:i' }}</td>
          <td class="py-1 pr-3">{{ p.method }}</td>
          <td class="py-1 pr-3">{{ p.provider }}</td>
          <td class="py-1 pr-3">{{ p.provider_reference }}</td>
          <td class="py-1 pr-3">{{ p.get_status_display }}</td>
          <td class="py-1 pr-3 text-right">£{{ p.amount }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
      <p class="text-sm text-slate-600">No payments recorded yet.</p>
    {% endif %}
  </div>
  <div class="mb-6">
    <h2 class="text-sm font-semibold text-slate-700 mb-2">Build Progress</h2>
    <ul class="text-sm space-y-1">
      <li>
        <span class="text-slate-500">Payment confirmed:</span>
        {% if invoice.paid_at %}<span class="font-medium">{{ invoice.paid_at|date:'Y-m-d H:i' }}</span>{% else %}<span class="text-slate-400">Not yet</span>{% endif %}
      </li>
      <li>
        <span class="text-slate-500">Items in stock:</span>
        {% if invoice.items_in_stock_at %}<span class="font-medium">{{ invoice.items_in_stock_at|date:'Y-m-d H:i' }}</span>{% else %}<span class="text-slate-400">Not yet</span>{% endif %}
      </li>
      <li>
        <span class="text-slate-500">Build date:</span>
        {% if invoice.build_date %}<span class="font-medium">{{ invoice.build_date|date:'Y-m-d' }}</span>{% else %}<span class="text-slate-400">Not scheduled</span>{% endif %}
      </li>
      <li>
        <span class="text-slate-500">Shipping date:</span>
        {% if invoice.shipping_date %}<span class="font-medium">{{ invoice.shipping_date|date:'Y-m-d' }}</span>{% else %}<span class="text-slate-400">Not scheduled</span>{% endif %}
      </li>
    </ul>
    {% if invoice.events.all %}
    <div class="mt-3 text-xs text-slate-600">
      <p class="font-semibold mb-1">Recent staff updates</p>
      <p class="mb-1">Assigned to: <span class="font-medium">{% with staff=invoice.assigned_to %}{% if staff %}{{ staff.get_full_name|default:staff.username }}{% else %}Not assigned{% endif %}{% endwith %}</span></p>
      <ul class="space-y-1">
        {% for e in invoice.events.all|dictsortreversed:'created_at' %}
          <li>• {{ e.created_at|date:'Y-m-d H:i' }} — {{ e.get_type_display }}{% if e.message %}: {{ e.message }}{% endif %}</li>
        {% empty %}
          <li class="text-slate-400">No updates yet.</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>
  <div class="mb-6">
    <h2 class="text-sm font-semibold text-slate-700 mb-2">Quote Line Items</h2>
    {% if invoice.quote.items.all %}
    <table class="min-w-full text-xs">
      <thead class="border-b">
        <tr class="text-slate-600">
          <th class="py-1 pr-3 text-left">Description</th>
          <th class="py-1 pr-3 text-right">Qty</th>
          <th class="py-1 pr-3 text-right">Unit (£)</th>
          <th class="py-1 pr-3 text-right">VAT %</th>
          <th class="py-1 pr-3 text-right">Line Total (£)</th>
        </tr>
      </thead>
      <tbody class="divide-y">
        {% for item in invoice.quote.items.all %}
        <tr>
          <td class="py-1 pr-3">{{ item.description }}</td>
          <td class="py-1 pr-3 text-right">{{ item.quantity }}</td>
          <td class="py-1 pr-3 text-right">{{ item.unit_price }}</td>
          <td class="py-1 pr-3 text-right">{{ item.vat_rate }}</td>
          <td class="py-1 pr-3 text-right">{{ item.total }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
      <p class="text-sm text-slate-600">No line items found.</p>
    {% endif %}
  </div>
  <div class="flex gap-3">
    <a href="{% url 'quotes:invoice_pdf' invoice.number %}" class="inline-flex items-center px-5 py-2.5 rounded-md bg-blue-600 text-white text-sm font-semibold hover:bg-blue-500" target="_blank" rel="noopener">View PDF</a>
    <a href="{% url 'quotes:public_quote_detail' invoice.quote.token %}" class="inline-flex items-center px-5 py-2.5 rounded-md bg-slate-200 text-slate-800 text-sm font-medium hover:bg-slate-300">View Quote</a>
    <a href="{% url 'accounts:invoices' %}" class="inline-flex items-center px-5 py-2.5 rounded-md bg-slate-200 text-slate-800 text-sm font-medium hover:bg-slate-300">Back to list</a>
    {% if can_pay %}
      <a href="{% url 'accounts:invoice_payment_methods' invoice.number %}" class="inline-flex items-center px-5 py-2.5 rounded-md bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-500">Payment Methods</a>
    {% endif %}
  </div>
</div>
{% endblock %}